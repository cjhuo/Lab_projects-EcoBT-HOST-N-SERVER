{% extends "main.html" %}

{% block header %}
	<!--<h1>{{ header_text }}</h1>-->
{% end %}

{% block body %}
	
	<div id="map_canvas" style="width:100%; height:100%"> </div>
{% end %}

{% block footer %}
	<!--{{ footer_text }}-->
{% end %}

{% block script_include %}
    <link href="https://developers.google.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
    <script src="http://maps.google.com/maps/api/js?sensor=true&language=en"></script>
    

<!--[if lte IE 8]>
<script language="javascript" type="text/javascript" src="{{ static_url("js/flot/excanvas.min.js") }}">
<![endif]-->
<script language="javascript" type="text/javascript" src="{{ static_url("js/flot/jquery.js") }}"></script>
<script language="javascript" type="text/javascript" src="{{ static_url("js/flot/jquery.flot.js") }}"></script>
{% end %}

{% block script %}
<script type="text/javascript">
$(function () {

	  var geocoder;
      var map;
      var infowindow = new google.maps.InfoWindow();
      
      var marker;
      var latlng;
      var plot;
      
      function initialize() {
        geocoder = new google.maps.Geocoder();
        latlng = new google.maps.LatLng(33.643751, -117.841008);
        var mapOptions = {
          zoom: 18,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.HYBRID
        }
        map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
        
        marker = new google.maps.Marker({
          map:map,
          draggable:false,
          animation: google.maps.Animation.DROP,
          position: latlng
        });
        google.maps.event.addListener(marker, 'click', showInfo);       
      }     
      
	var data = [], totalPoints = 300;
	function getRandomData() {
		if (data.length > 0)
			data = data.slice(1);

		while (data.length < totalPoints){
			var prev = data.length > 0 ? data[data.length - 1] : 50;
			var y = prev + Math.random() * 10 - 5;
			if (y < 0)
				y = 0;
			if (y > 100)
				y = 100;
			data.push(y);
		}

		var res = [];
		for (var i = 0; i < data.length; ++i)
			res.push([i, data[i]]);
		return res;
	}

	function onDataReceived(series) {
		if (data.length > 0){
			data = data.slice(0, -1);
		}

		data.unshift(series.point);
	}

	function dataToRes() {
		var res = [];
		for (var i = 0; i < data.length; ++i)
			res.push([i, data[i]]);
		return res;
	}

	var timeVar;
	var updateInterval = 1000;
	// setup plot
	var options = {
		series: {shadowSize: 0},
		yaxis: {min: 0, max: 100},
		xaxis: {show: true}
	};

	//var plot = $.plot($("#plotholder"), [ getRandomData() ], options);
	var dataurl = "point";
	
	function showInfo() {
		clearTimeout(timeVar);
		var div = document.createElement('DIV');
		div.style.cssText = 'position:relative; width:600px;height:300px';
			
		// setup plot
		var options = {
	        	series: { shadowSize: 0 }, // drawing is faster without shadows
	        	yaxis: { position: "right", min: 0, max: 100 },
	        	xaxis: { show: true }
		};					
			    
		plot = $.plot(div, [ getRandomData() ], options);
	      		
		infowindow.setContent(div);
		infowindow.open(map, marker);
		update();
      }
      
      	function update() {
		$.ajax({
			url: dataurl,
			cache: false,
			method: 'GET',
			dataType: 'json',
			success: onDataReceived
		});

		plot.setData([ dataToRes() ]);
//		plot.setupGrid();
		plot.draw();

		timeVar = setTimeout(update, updateInterval);
	}

initialize();
	
});
</script>
{% end %}
